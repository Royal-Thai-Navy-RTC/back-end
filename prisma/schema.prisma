generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// --------------------------------------------------
// ENUM DEFINITIONS
// ใช้ ASCII values + map เป็น label ภาษาไทยใน DB
// --------------------------------------------------
enum Role {
  ADMIN   @map("แอดมิน")
  DEPARTMENT_HEAD @map("หัวหน้าแผนกศึกษา")
  TEACHER @map("ครูผู้สอน")
  STUDENT @map("นักเรียน")
}

enum Rank {
  ADMIRAL        @map("พลเรือเอก")
  ADMIRAL_FEMALE @map("พลเรือเอกหญิง")

  VICE_ADMIRAL        @map("พลเรือโท")
  VICE_ADMIRAL_FEMALE @map("พลเรือโทหญิง")

  REAR_ADMIRAL        @map("พลเรือตรี")
  REAR_ADMIRAL_FEMALE @map("พลเรือตรีหญิง")

  CAPTAIN        @map("นาวาเอก")
  CAPTAIN_FEMALE @map("นาวาเอกหญิง")

  COMMANDER        @map("นาวาโท")
  COMMANDER_FEMALE @map("นาวาโทหญิง")

  LIEUTENANT_COMMANDER        @map("นาวาตรี")
  LIEUTENANT_COMMANDER_FEMALE @map("นาวาตรีหญิง")

  LIEUTENANT        @map("เรือเอก")
  LIEUTENANT_FEMALE @map("เรือเอกหญิง")

  SUB_LIEUTENANT        @map("เรือโท")
  SUB_LIEUTENANT_FEMALE @map("เรือโทหญิง")

  ENSIGN        @map("เรือตรี")
  ENSIGN_FEMALE @map("เรือตรีหญิง")

  PETTY_OFFICER_1        @map("พันจ่าเอก")
  PETTY_OFFICER_1_FEMALE @map("พันจ่าเอกหญิง")

  PETTY_OFFICER_2        @map("พันจ่าโท")
  PETTY_OFFICER_2_FEMALE @map("พันจ่าโทหญิง")

  PETTY_OFFICER_3        @map("พันจ่าตรี")
  PETTY_OFFICER_3_FEMALE @map("พันจ่าตรีหญิง")

  LIEUTENANT_COLONEL        @map("พันโท")
  LIEUTENANT_COLONEL_FEMALE @map("พันโทหญิง")

  MAJOR        @map("พันตรี")
  MAJOR_FEMALE @map("พันตรีหญิง")

  PETTY_OFFICER        @map("จ่าเอก")
  PETTY_OFFICER_FEMALE @map("จ่าเอกหญิง")

  LEADING_RATING        @map("จ่าโท")
  LEADING_RATING_FEMALE @map("จ่าโทหญิง")

  ABLE_SEAMAN        @map("จ่าตรี")
  ABLE_SEAMAN_FEMALE @map("จ่าตรีหญิง")

  SEAMAN_RECRUIT @map("พลฯ")
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
}

// --------------------------------------------------
// USER MODEL (บุคลากร / กำลังพล)
// --------------------------------------------------
model User {
  // --- ระบบ / Primary Key ---
  id Int @id @default(autoincrement())

  // --- ข้อมูลเข้าใช้ระบบ ---
  username     String  @unique @db.VarChar(64) // ชื่อผู้ใช้ (ห้ามซ้ำ)
  passwordHash String  @db.VarChar(255) // เก็บรหัสผ่านแบบ hash
  role         Role    @default(STUDENT) // บทบาทในระบบ (แอดมิน/ครู/นักเรียน)
  isActive     Boolean @default(true) // ใช้งานอยู่หรือไม่ (สำหรับ soft delete)

  // --- ข้อมูลส่วนบุคคล ---
  firstName   String   @db.VarChar(100) // ชื่อจริง
  lastName    String   @db.VarChar(100) // นามสกุล
  birthDate   DateTime // วันเกิด
  rank        Rank     @default(SEAMAN_RECRUIT) // ยศทหารเรือไทย
  fullAddress String   @db.VarChar(255) // ที่อยู่เต็ม

  // --- ประวัติการศึกษา / ตำแหน่ง ---
  education String? @db.VarChar(255) // ประวัติการศึกษา (อาจไม่มี หรือใช้ “วุฒิสูงสุด”)
  position  String? @db.VarChar(150) // ตำแหน่งปัจจุบัน/ตำแหน่งงาน

  // --- การติดต่อหลัก ---
  email String @unique @db.VarChar(191) // อีเมล (ห้ามซ้ำ)
  phone String @unique @db.VarChar(32) // เบอร์โทรศัพท์ (ห้ามซ้ำ)

  // --- ข้อมูลติดต่อฉุกเฉิน ---
  emergencyContactName  String? @db.VarChar(100) // ชื่อผู้ติดต่อฉุกเฉิน
  emergencyContactPhone String? @db.VarChar(32) // เบอร์โทรผู้ติดต่อฉุกเฉิน

  // --- ข้อมูลด้านการแพทย์ (Sensitive) ---
  medicalHistory String? @db.Text // ประวัติทางการแพทย์ (ควรเข้ารหัส/จำกัดสิทธิ์)

  // --- อื่น ๆ ---
  avatar String? @db.Text // URL หรือ base64 รูปโปรไฟล์

  createdAt DateTime @default(now()) // วันที่สร้างข้อมูล
  updatedAt DateTime @updatedAt // อัปเดตอัตโนมัติทุกครั้งที่แก้ไข

  // --- Indexes สำหรับการค้นหา ---
  @@index([lastName, firstName])
  @@index([rank])
  @@index([role])

  // ความสัมพันธ์กับแบบประเมินที่ตนเป็นผู้สอน (ถ้ามีการผูก teacherId)
  evaluationsReceived EvaluationSheet[] @relation("TeacherEvaluations")

  // รายงานยอดนักเรียนที่ครูส่ง
  trainingReports TrainingReport[]

  // คำขอลาของครูฝึก
  teacherLeaves           TeacherLeave[] @relation("TeacherLeaves")
  departmentApprovedLeaves TeacherLeave[] @relation("DepartmentApproval")
}

// --------------------------------------------------
// TEACHING EVALUATION MODELS (แบบประเมินครู)
// --------------------------------------------------
model EvaluationSheet {
  id            Int       @id @default(autoincrement())

  // รายวิชา + ครูผู้สอน
  subject       String    @db.VarChar(191)
  teacherName   String    @db.VarChar(191)

  // อ้างอิงไปยัง User (role = TEACHER) ได้ ถ้ามี
  teacherId     Int?
  teacher       User?     @relation("TeacherEvaluations", fields: [teacherId], references: [id])

  // ผู้ประเมิน
  evaluatorName String    @db.VarChar(191)
  evaluatorUnit String?   @db.VarChar(255)
  evaluatedAt   DateTime  // วันที่ประเมินจากไฟล์ (ถ้าหาไม่ได้ให้ใช้เวลาปัจจุบัน)

  notes         String?   @db.Text

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  answers       EvaluationAnswer[]

  @@index([teacherId])
  @@index([teacherName])
  @@index([subject])
}

model EvaluationAnswer {
  id        Int              @id @default(autoincrement())
  sheetId   Int
  sheet     EvaluationSheet   @relation(fields: [sheetId], references: [id], onDelete: Cascade)

  // ตัวชี้วัด/หัวข้อประเมิน
  section   String?           @db.VarChar(32)
  itemCode  String?           @db.VarChar(32)
  itemText  String            @db.VarChar(255)

  // คะแนนแบบ Likert 1..5 (5 = พึงพอใจมากที่สุด)
  rating    Int

  @@index([sheetId])
}

// --------------------------------------------------
// TRAINING REPORTS (ยอดนักเรียน/รายงานการฝึกของครู)
// --------------------------------------------------
model TrainingReport {
  id               Int      @id @default(autoincrement())
  teacherId        Int
  teacher          User     @relation(fields: [teacherId], references: [id])

  subject          String   @db.VarChar(191)
  participantCount Int
  company          String?  @db.VarChar(150) // ร้อยฝึกที่
  battalion        String?  @db.VarChar(150) // พันฝึกที่
  trainingDate     DateTime
  trainingTime     String?  @db.VarChar(16) // HH:mm
  location         String?  @db.VarChar(191)
  durationHours    Float
  notes            String?  @db.Text

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([teacherId, trainingDate])
}

// --------------------------------------------------
// TEACHER LEAVE (บัญชีพล / การลา)
// --------------------------------------------------
model TeacherLeave {
  id          Int          @id @default(autoincrement())
  teacherId   Int
  teacher     User         @relation("TeacherLeaves", fields: [teacherId], references: [id])

  leaveType   String       @db.VarChar(100)
  destination String?      @db.VarChar(191)
  reason      String?      @db.Text
  startDate   DateTime
  endDate     DateTime?
  status      LeaveStatus  @default(PENDING)
  isOfficialDuty Boolean   @default(false)

  departmentApprovalStatus LeaveStatus?
  departmentApprovalBy     Int?
  departmentApprover       User?        @relation("DepartmentApproval", fields: [departmentApprovalBy], references: [id])
  departmentApprovalAt     DateTime?

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([teacherId, startDate])
  @@index([isOfficialDuty, status])
}
